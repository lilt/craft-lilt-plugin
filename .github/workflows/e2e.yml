name: E2E Tests
on:
  push:
    branches:
      - 1.x #CraftCMS v3 | PHP 7.2
      - 2.x #CraftCMS v4 | PHP 8.0.2
  pull_request:
    branches:
      - "*"
jobs:
  tests:
    strategy:
#      max-parallel: 1
      matrix:
        os: [ ubuntu-latest ]
        scenario: [
          "cypress/e2e/jobs/copy-source-text-flow/filters.cy.js",
          "cypress/e2e/jobs/copy-source-text-flow/success-path-multiple.cy.js",
          "cypress/e2e/jobs/copy-source-text-flow/success-path-single.cy.js",
          "cypress/e2e/jobs/instant/success-path-multiple-1.cy.js",
          "cypress/e2e/jobs/instant/success-path-multiple-2.cy.js",
          "cypress/e2e/jobs/instant/success-path-multiple-3.cy.js",
          "cypress/e2e/jobs/instant/success-path-multiple-4.cy.js",
          "cypress/e2e/jobs/verified/success-path-multiple-bulk-publishing-1.cy.js",
          "cypress/e2e/jobs/verified/success-path-multiple-bulk-publishing-2.cy.js",
          "cypress/e2e/jobs/verified/success-path-multiple-bulk-publishing-3.cy.js",
          "cypress/e2e/jobs/verified/success-path-multiple-bulk-publishing-4.cy.js",
          "cypress/e2e/jobs/verified/success-path-multiple-single-publishing-1.cy.js",
          "cypress/e2e/jobs/verified/success-path-multiple-single-publishing-2.cy.js",
          "cypress/e2e/jobs/verified/success-path-multiple-single-publishing-3.cy.js",
          "cypress/e2e/jobs/verified/success-path-multiple-single-publishing-4.cy.js",
          "cypress/e2e/jobs/verified/success-path-single.cy.js",
          "cypress/e2e/jobs/instant/success-path-single.cy.js",
        ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set the value
        id: step_one
        run: |
          echo "CYPRESS_SCENARIO=${{ matrix.scenario }}" >> $GITHUB_ENV
          echo "DB_DATABASE=$(uuidgen)" >> $GITHUB_ENV
      - name: Run automation
        working-directory: ./e2e
        run: |
          echo ${DB_DATABASE}
          make up
          make e2e-github
      - name: Copy artifacts
        if: ${{ failure() }}
        run: |
          make backup-db
          mkdir e2e/cypress/craft
          mkdir e2e/cypress/craft/logs
          cp -R happy-lager-main/storage/logs cypress/craft/logs | true
          cp happy-lager-main/composer.json e2e/cypress/craft
          cp happy-lager-main/composer.lock e2e/cypress/craft
      - name: Use the Upload Artifact GitHub Action
        uses: actions/upload-artifact@v2
        if: ${{ failure() }}
        with:
          name: screenshots-e2e-instant
          path: |
            ./e2e/cypress
            ./e2e/happy-lager-main/storage